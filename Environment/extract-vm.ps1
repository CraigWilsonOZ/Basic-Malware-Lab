
# Download Microsoft Virtual Machine Converter
Invoke-WebRequest https://download.microsoft.com/download/9/1/E/91E9F42C-3F1F-4AD9-92B7-8DD65DA3B0C2/mvmc_setup.msi -OutFile mvmc_setup.msi

# Download Disk editing tool
Invoke-WebRequest https://www.mysysadmintips.com/-downloads-/Windows/Servers/dsfok.zip -OutFile dsfok.zip

# Install Microsoft Virtual Machine Converter.
$webDeployInstallerFilePath = ".\mvmc_setup.msi"
$arguments = "/i `"$webDeployInstallerFilePath`" /quiet /L*V `".\install.log`""
Start-Process msiexec.exe -ArgumentList $arguments -Wait

# Import Microsoft Virtual Machine Converter PowerShell module
Import-Module 'C:\Program Files\Microsoft Virtual Machine Converter\MvmcCmdlet.psd1'

# Collect disk information
.\dsfo.exe "D:\zzen9201\zzen9201-lab-machine\zzen9201-lab-machine-disk001.vmdk" 512 1024 "D:\zzen9201\zzen9201-lab-machine\descriptor.txt"

# Open the descriptor.txt file and comment out the followig lines:
# #ddb.uuid.image="3e9b6b48-8812-4a19-a928-fa0a60580c72"
# #ddb.uuid.parent="00000000-0000-0000-0000-000000000000"
# #ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
# #ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
# #ddb.comment=""

# Update teh vmdk file information
.\dsfi.exe "D:\zzen9201\zzen9201-lab-machine\zzen9201-lab-machine-disk001.vmdk" 512 1024 "D:\zzen9201\zzen9201-lab-machine\descriptor.txt"

# Run the convert command to move to VHD
ConvertTo-MvmcVirtualHardDisk -SourceLiteralPath "D:\zzen9201\zzen9201-lab-machine\zzen9201-lab-machine-disk001.vmdk" -VhdType DynamicHardDisk -VhdFormat vhdx -destination D:\zzen9201\

# Now we have valid vmdk and vhdx disk. We can use these in Azure, AWS, GCP or Hyper-V/VMware

# Once you have the VM started you can SSH directly to the VM. Use the login zzen9201 with the password hunter_2
ssh zzen9201@IPaddressofVM

# I have placed a number of scripts in the "Scripts" folder to help with getting the VM update.

# - config-vm-base.sh
# This script will update SSH keys so we all have different ones and run a patching cycle.
# Placing this VM on the internal is a risk as all the SSH keys are the same.

# - install-dotnet.sh and install-software.sh
# These scripts just install some basic software like Discord, Teams, Edge, Postman

# - upgrade-distro.sh
# This script will upgrade ubuntu from 1804 to 20.04

# - create-vm.ps1
# This script will create a hyper-v VM on you system, if you have hyper-v turned on. 
# You will need to update it wtih your settings.





