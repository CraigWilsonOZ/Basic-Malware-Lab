# Environment Builds

This document contains all the build process for the VMs.

## Creating a Hyper-V Virtual Machine from the REMnux OVA

This process will help you convert the OVA to a working VMDK and VHDX
for use on another system. The REMnux image has been set up for Virtual
Box and VMware; as I use Hyper-V, Azure, and AWS, I need the files in
VHDX/VMDK.

### Setup

You will need to download a few tools first.

#### Download Microsoft Virtual Machine Converter

Download the Microsoft Virtual Machine Converter; this will be used to
convert the VMDK to VHDX.

```PowerShell
Invoke-WebRequest
https://download.microsoft.com/download/9/1/E/91E9F42C-3F1F-4AD9-92B7-8DD65DA3B0C2/mvmc_setup.msi -OutFile mvmc_setup.msi
```

#### Install Microsoft Virtual Machine Converter

Once downloaded, run the following to perform a silent install or just
run the MSI.

```PowerShell
$webDeployInstallerFilePath = ".\mvmc_setup.msi"
$arguments = "/i `"$webDeployInstallerFilePath`" /quiet /L*V `".\install.log`""
Start-Process msiexec.exe -ArgumentList $arguments -Wait
```

#### Download Disk editing tool

Download the disk editing tool and extract it ready for use.

```PowerShell
Invoke-WebRequest https://www.mysysadmintips.com/-downloads-/Windows/Servers/dsfok.zip -OutFile dsfok.zip
```

#### Unzipping the OVA

The OVA file is just an archive. To extract the files, I used WinRAR.
This can be downloaded from this
site. <https://www.rarlab.com/download.htm>

#### Unzipping the gzip

The vmdk is in a gzip file, which is just an archive. To extract the
files, I used WinRAR. This can be downloaded from this
site. <https://www.rarlab.com/download.htm>

### Running the conversion

This process will load a PowerShell module, extract some disk
configuration and update the VMDK before the conversion.

#### Import Microsoft Virtual Machine Converter PowerShell module

```PowerShell
Import-Module 'C:\Program Files\Microsoft Virtual Machine Converter\MvmcCmdlet.psd1'
```

#### Collect disk information

```PowerShell
.\dsfok\dsfo.exe "D:\Remux\remnux-v7-focal-disk1.vmdk" 512 1024 "D:\Remux\remnux-v7-focal-disk1.vmdk-descriptor.txt"
```

#### Open the descriptor.txt file and comment out the following lines

Check for lines that may have UUID values. If so remove them.

```bash
#ddb.uuid.image="00000000-0000-0000-0000-000000000000"
#ddb.uuid.parent="00000000-0000-0000-0000-000000000000"
#ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
#ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
#ddb.comment=""
```

Remove the lines with \"4\" as well.

```bash
#ddb.toolsInstallType = "4"
#ddb.toolsVersion = "11333"
#ddb.virtualHWVersion = "4"
```

#### Update the vmdk file information

If required, run the following command to update the disk.

```PowerShell
.\dsfok\dsfo.exe "D:\Remux\remnux-v7-focal-disk1.vmdk" 512 1024 "D:\Remux\remnux-v7-focal-disk1.vmdk-descriptor.txt"
```

#### Run the convert command to move to VHD

```PowerShell
ConvertTo-MvmcVirtualHardDisk -SourceLiteralPath "D:\Remux\remnux-v7-focal-disk1.vmdk" -VhdType DynamicHardDisk -VhdFormat vhdx -destination D:\Remux\
```

### Post configuration

Now we have valid vmdk and vhdx disk. We can use these in Azure, AWS,
GCP or Hyper-V/VMware

Once the VM starts, you can SSH directly to the VM. Use the login remnux
Password: malware

```bash
ssh remnux@IPaddressofVM
```

I have placed several scripts in the \"Scripts\" folder to help with
getting the VM update.

#### Scripts

- extract-vm.ps1 This script has the base command to extract and convert the OVA to VHDX, VMDK and commands from this readme.

- config-vm-base.sh This script will update SSH keys, so we all have different ones and run a patching cycle. Placing this VM on the internal is a risk as all the SSH keys are the same.

- install-dotnet.sh and install-software.sh These scripts just install some basic software like Discord, Teams, Edge, Postman

- upgrade-distro.sh This script will upgrade Ubuntu from 1804 to 20.04

- create-vm.ps1 This script will create a hyper-v VM on your system if you have hyper-v turned on. You will need to update it with your
    settings.

#### Getting *scripts* *to* the VM

If you like me and want to run the scripts, you need to upload them to
the server. This can be done with a simple python webserver.

```bash
python3 -m http.server
```

This will open a web server, then you can just remotely get the files in
your SSH connection.

On your new Linux VM, you need to make a directory and download the
files. As we are coming from windows will need to clean up the files as
well.

```bash
mkdir scripts
cd scripts
# Download files
wget -A sh -r -l 1 -nd http://192.168.86.32:8000/remnux/Scripts/
# Clean up files
sed -e "s/\r//g" config-vm-base.sh > config-vm-base-c.sh
sed -e "s/\r//g" install-dotnet.sh > install-dotnet-c.sh
sed -e "s/\r//g" upgrade-distro.sh > upgrade-distro-c.sh
sed -e "s/\r//g" install-software.sh > install-software-c.sh
# Make the scripts executable
chmod +x *.sh
```

Now the scripts are ready, just run them in this order.

```bash
sudo ./config-vm-base-c.sh
sudo reboot
sudo ./upgrade-distro-c.sh #(If you want to be on the latest OS versions, just hit Y when prompted and accept defaults)
sudo reboot
sudo ./install-dotnet-c.sh
sudo ./install-software-c.sh
sudo reboot
```

### Troubleshooting

#### GRUB on the update distro

If you update the distro, install GRUB on the devices.

```bash
GRUB install devices:
[*] /dev/sda (16106 MB; Virtual_Disk)
[*] - /dev/sda1 (16104 MB; /
```

#### Ubuntu Version Check

This can be done by running the following command.

```bash
lsb_release -a

No LSB modules are available.
Distributor ID: Ubuntu
Description: Ubuntu 18.04.6 LTS
Release: 18.04
Codename: bionic
```

#### SSH cannot log in

After changing the SSH keys, you would get an error if you cached the
keys before. This can be fixed by removing the known host\'s file entry.

```bash
ssh remnux@IPaddressofVM

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:LQWh4IUSJsHzq3Cgq0Jd8E3T+mRy7MWuL/QbLYKEoGk.
Please contact your system administrator.
Add correct host key in C:\\Users\\Username/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in C:\\Users\\Username/.ssh/known_hosts:3
ECDSA host key for 192.168.86.39 has changed and you have requested strict checking.
Host key verification failed.

# Fix
del C:\Users\Username\.ssh\known_hosts
```

### Post Deployment

Change the user password. People new to Linux run "passwd" in a shell.

## Creating a Hyper-V Virtual Machine from the REMnux Script

This process will help you set up REMnux on Hyper-V

### Setup Hyper-V VM

Download ubuntu 20.04 from <https://ubuntu.com/download/desktop>

#### Create a VM

Inside Hyper-V creates a standard Gen 1 VM and uses the ISO downloaded
as the boot media.

CPU: 2 Core Memory: 8 GB static Disk: 60 GB ISO: Boot from ISO
Snapshots: Disabled

#### Follow the prompts to install Ubuntu

Following the prompt to install the ubuntu desktop. Once installed, run
a full update

```bash
sudo apt update && sudo apt upgrade -y
```

### Update Ubuntu to REMnux

#### Get the REMnux Installer

```bash
wget https://REMnux.org/remnux-cli
mv remnux-cli remnux
chmod +x remnux
sudo mv remnux /usr/local/bin
```

#### Install GnuPG

```bash
sudo apt install -y gnupg
```

#### Run the REMnux Installer

```bash
sudo remnux install \--mode=cloud
```

#### Reboot

```bash
sudo reboot
```

## Creating a Hyper-V Virtual Machine with Windows 10 Flare VM

### Stage 1: Getting the Environment ready

This process starts with a Windows 10 VM. The first part is a simple VM
install.

1. Download load a Windows 10 image from the following locations:
    <https://www.microsoft.com/en-us/software-download/windows10>
    <https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise>

2. Creation of a VM using Hyper-V with 2 CPUs, 8 GB RAM, and 64 GB storage.

3. Once the OS has been installed, the following services need to be disabled:

Disable Windows Defender by following the procedures outlined: <https://www.howtogeek.com/howto/15788/how-to-uninstall-disable-and-remove-windows-defender-also-how-turn-it-off/>

Disable the following settings:

- Disable real-time protection
- Disable cloud-delivered protection
- Disable automatic sample submission
- Add the directory C:\\ to the exclusion list

### Stage 2: Installing Tools (Flare VM)

An install script from FireEye will be used to configure the VM with
Flare VM. It\'s a free script configuring a Windows Vista and above VM
with the trial, open-source, and free tools to analyse Malware.

<https://www.fireeye.com/services/freeware/flare-vm.html>

The Git Repo has additional information about the tool and can be found
here: <https://github.com/mandiant/flare-vm>

The following is the installation process for script and Flare VM tools.

1. Open PowerShell as an Administrator

2. Unblock the install file by running:

    Unblock-File .\\install.ps1

3. Enable script execution by running:

    Set-ExecutionPolicy Unrestricted

4. Finally, execute the installer script as follow:

    ```PowerShell
    .\\install.ps1 -password \<password\>
    ```

This process will take a few hours to complete.

![A screenshot of a computer Description automatically generated with
medium confidence](./media/image1.png)
