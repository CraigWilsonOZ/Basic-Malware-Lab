# Create Linux VM from ISO

#Variables
$Name = "zzen9201"
$MemoryBoot = 4 * 1024 * 1024 * 1024
$MemoryMin = 4 * 1024 * 1024 * 1024
$MemoryMax = 4 * 1024 * 1024 * 1024
$CPUs = 2
$AutomaticStartDelay = 60
$vmconfigdrive = "D:"
$vmdiskdrive = "D:"
$Generation = 1
$VMData  = "$($vmconfigdrive)\Hyper-V\Virtual Machines"
$VHDpath  = "$($vmdiskdrive)\Hyper-V\Virtual Hard Disks"
$VHDDisk = "\zzen9201-lab-machine-disk001.vhdx"

$Switch = "External-Switch"

$CheckpointType = "Disabled" # Use Standard/Production/ProductionOnly

New-VM -Name $Name -MemoryStartupBytes $MemoryBoot `
       -BootDevice VHD -VHDPath "$($VHDpath)$($VHDDisk)" `
       -Path $VMData -Generation $Generation -Switch $Switch

$VM = Get-VM -Name $Name

set-vm -VM $vm -ProcessorCount $CPUs -DynamicMemory `
       -MemoryStartupBytes $MemoryBoot -MemoryMinimumBytes $MemoryMin -MemoryMaximumBytes $MemoryMax `
       -AutomaticStartAction StartIfRunning -AutomaticStartDelay $AutomaticStartDelay `
       -SmartPagingFilePath $VHDpath -SnapshotFileLocation $VHDpath -CheckpointType $CheckpointType

# Update VM for booting

if ($Generation -eq 2)
{
    $VMFirmware = Get-VMFirmware -VM $VM
    $BootHDD0 = $VMFirmware.BootOrder | Where-Object {$_.Device -match "'Hard Drive on SCSI controller number 0 at location 0'"}
    $BootPXE = $VMFirmware.BootOrder | Where-Object {$_.Device -match "VMNetworkAdapter"}
    $BootISO = $VMFirmware.BootOrder | Where-Object {$_.Device -match "DvdDrive"}
    Set-VMFirmware -vm $VM -BootOrder $BootISO, $BootPXE, $BootHDD0
} else
{
    Set-VMBios -vm $VM -StartupOrder CD,IDE,LegacyNetworkAdapter,Floppy
}

# Setting Hyper-V sessions type. May not be required
# Set-VM -vm $VM -EnhancedSessionTransportType HVSocket
Set-VM -vm $VM -EnhancedSessionTransportType VMBus